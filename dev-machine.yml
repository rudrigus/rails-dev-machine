---
- name: Configure machine for rails development
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    force: no
    initialize: yes
    root: /

  pre_tasks:
    - name: Install the requirements
      apt:
        pkg:
          - git
          - git-cola
          - build-essential
          - autoconf
          - bison
          - libssl-dev
          - libyaml-dev
          - libreadline-dev
          - zlib1g-dev
          - libncurses5-dev
          - libffi-dev
          - libgdbm-dev
          - libpq-dev
          - curl
          - ruby-full
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg2
          - software-properties-common
          - direnv
          - jq

  tasks:
    - name: Add repositories
      shell: |
        apt remove docker docker-engine docker.io containerd runc
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --batch --yes --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
        echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list

    - name: Install packets
      apt:
        pkg:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - yarn
          - apt-transport-https

    - name: Install aws-cli
      pip:
        name: awscli

    - name: Config Docker
      user:
        name: "{{ user }}"
        groups: docker
        append: yes

    - name: Config Direnv
      lineinfile:
        path: /home/{{ user }}/{{ item.filename }}
        line: "{{ item.text }}"
        state: present
        create: yes
        group: "{{ user }}"
        owner: "{{ user }}"
      loop:
        - { filename: '.bashrc', text: 'eval "$(direnv hook bash)"' }
        - { filename: '.envrc', text: 'export MONGO_PREFIX="docker exec -i sgm-mongo"' }

    - name: Config Direnv part2
      become: yes  
      become_user: "{{ user }}"
      command: direnv allow

